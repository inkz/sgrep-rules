rules:
  - id: tempfile-without-flush
    patterns:
      - pattern-either:
        - patterns:
          - pattern-inside: |
              $F = tempfile.NamedTemporaryFile(...)
              ...
          - pattern-not-inside: |
              $F.write(...)
              ...
              $F.flush()
              ...
          - pattern-not-inside: |
              $F.write(...)
              ...
              $F.close()
              ...
          - pattern: $F.name
    message: "possibly missing a .flush() or .close() call to temporary file $F; file may or may not exist when $F.name is used"
    languages: [python]
    severity: ERROR
    # TODO: when with() equivalence support is released, this rule is redundant
  - id: tempfile-without-flush-with-stmt
    patterns:
      - pattern-not-inside: |
          with tempfile.NamedTemporaryFile(...) as $F:
              ...
              $F.write(...)
              ...
              $F.flush()
              ...
      - pattern-not-inside: |
          with tempfile.NamedTemporaryFile(...) as $F:
              ...
              $F.write(...)
              ...
              $F.close()
              ...
      - pattern-inside: |
          with tempfile.NamedTemporaryFile(...) as $F:
             ...
      - pattern: $F.name
    message: "possibly missing a .flush() or .close() call to temporary file $F; file may or may not exist when $F.name is used"
    languages: [python]
    severity: ERROR    
